<!DOCTYPE html>
<html lang="zh-CN">
<html class="dark light">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    
    
    
    <title>
         Use backrest for Linux full backup
        
    </title>

        
            <meta property="og:title" content="Use backrest for Linux full backup" />
        
     

     
         
             <meta property="og:description" content="This is Yon Zilch&#x27;s Blog." />
         
     

     
         
             <meta name="description" content="This is Yon Zilch&#x27;s Blog." />
         
    

    
    
        <link rel="icon" type="image/png" href=https:&#x2F;&#x2F;static.yon.im&#x2F;image&#x2F;avatar.webp />
    


    


    
    <link rel="alternate" type="application/atom+xml" title="Yon Zilch" href="https://blog.yon.im/atom.xml">


    
        <link rel="stylesheet" type="text/css" href="https://blog.yon.im/theme/dark.css" />
        <link rel="stylesheet" type="text/css" media="screen" href=https://blog.yon.im/main.css />


    
</head>


<body>
    <div class="content">
        <header>
    <div class="main">
        <a href=https:&#x2F;&#x2F;blog.yon.im>Yon Zilch</a>

        <div class="socials">
            
            <a rel="me noopener noreferrer" href="&#x2F;atom.xml" target="_blank" class="social">
                <img alt=rss src=https://blog.yon.im/social_icons/rss.svg>
            </a>
            
            <a rel="me noopener noreferrer" href="https:&#x2F;&#x2F;codeberg.org&#x2F;yonzilch" target="_blank" class="social">
                <img alt=CodeBerg src=https://blog.yon.im/social_icons/codeberg.svg>
            </a>
            
            <a rel="me noopener noreferrer" href="https:&#x2F;&#x2F;github.com&#x2F;yonzilch" target="_blank" class="social">
                <img alt=GitHub src=https://blog.yon.im/social_icons/github.svg>
            </a>
            
            <a rel="me noopener noreferrer" href="https:&#x2F;&#x2F;mastodon.social&#x2F;@yonzilch" target="_blank" class="social">
                <img alt=Mastodon src=https://blog.yon.im/social_icons/mastodon.svg>
            </a>
            
            <a rel="me noopener noreferrer" href="https:&#x2F;&#x2F;matrix.to&#x2F;#&#x2F;@yonzilch:matrix.org" target="_blank" class="social">
                <img alt=matrix src=https://blog.yon.im/social_icons/matrix.svg>
            </a>
            
            <a rel="me noopener noreferrer" href="https:&#x2F;&#x2F;t.me&#x2F;yonzilch" target="_blank" class="social">
                <img alt=Telegram src=https://blog.yon.im/social_icons/telegram.svg>
            </a>
            
        </div>
    </div>

    <nav>
        
        <a href=https://blog.yon.im/posts style="margin-left: 0.7em">&#x2F;posts</a>
        
        <a href=https://blog.yon.im/links style="margin-left: 0.7em">&#x2F;links</a>
        
        <a href=https://blog.yon.im/about style="margin-left: 0.7em">&#x2F;about</a>
        
        <a href=https://blog.yon.im/search style="margin-left: 0.7em">&#x2F;search</a>
        
    
        
    </nav>
</header>


        
        
    
<main>
    <article>
        <div class="title">
            
            
    <div class="page-header">
        Use backrest for Linux full backup<span class="primary-color" style="font-size: 1.6em">.</span>
    </div>


                <div class="meta">
                    
                        Posted on <time>2024-10-02</time>
                    

                    
                </div>
        </div>

        

        
        
            
                <h1>Table of Contents</h1>
                <ul>
                
                    <li>
                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#needs">Needs</a>
                        
                    </li>
                
                    <li>
                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#overview">Overview</a>
                        
                    </li>
                
                    <li>
                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#before-you-go">Before you go</a>
                        
                    </li>
                
                    <li>
                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#prepare">Prepare</a>
                        
                    </li>
                
                    <li>
                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#install-backrest">Install backrest</a>
                        
                    </li>
                
                    <li>
                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#configure-backrest">Configure backrest</a>
                        
                            <ul>
                                
                                    <li>
                                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#add-repo">Add Repo:</a>
                                    </li>

                                    
                                
                                    <li>
                                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#add-plan">Add Plan:</a>
                                    </li>

                                    
                                
                                    <li>
                                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#test">Test:</a>
                                    </li>

                                    
                                
                            </ul>
                        
                    </li>
                
                    <li>
                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#restore">Restore</a>
                        
                            <ul>
                                
                                    <li>
                                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#first">First:</a>
                                    </li>

                                    
                                
                                    <li>
                                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#second">Second:</a>
                                    </li>

                                    
                                
                                    <li>
                                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#third">Third:</a>
                                    </li>

                                    
                                
                                    <li>
                                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#finally">Finally:</a>
                                    </li>

                                    
                                
                                    <li>
                                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#more-about-luks-encryption">More About LUKS encryption</a>
                                    </li>

                                    
                                
                            </ul>
                        
                    </li>
                
                    <li>
                        <a href="https://blog.yon.im/posts/use-backrest-for-linux-full-backup/#acknowledgements">Acknowledgements</a>
                        
                    </li>
                
                </ul>
            
        

        <section class="body">
            <h3 id="needs"><a class="zola-anchor" href="#needs" aria-label="Anchor link for: needs">Needs</a></h3>
<p>I am writing this post to record the effective method for establishing a automatic workflow that ensure my Linux desktop system is backed up correctly.</p>
<p>With no pain, and no messy things, totally use open-source software make this work seamlessly after configuring the process.</p>
<h2 id="overview"><a class="zola-anchor" href="#overview" aria-label="Anchor link for: overview">Overview</a></h2>
<ol>
<li>Prepare for the entire process</li>
<li>Install backrest manually</li>
<li>Configure backrest through webui</li>
<li>Perform a full backup and attempt a restore for a reliability test</li>
<li>Make it happen seamlessly</li>
<li>Fix systemd-boot under LiveCD</li>
</ol>
<h2 id="before-you-go"><a class="zola-anchor" href="#before-you-go" aria-label="Anchor link for: before-you-go">Before you go</a></h2>
<p><strong>!WARNING!</strong></p>
<p><strong>The following operations are done in my <a href="https://cachyos.org/">CachyOS</a> system, if you're using other Linux Distros, I can not promise that would work.But I think the whole process could be reproduced because of the idea: <a href="https://en.wikipedia.org/wiki/Everything_is_a_file">"Everything is a file"</a></strong></p>
<h2 id="prepare"><a class="zola-anchor" href="#prepare" aria-label="Anchor link for: prepare">Prepare</a></h2>
<p>Take me as an example, I install my CachyOS in an 240GB NVME disk, and I use <a href="https://wiki.archlinux.org/title/Systemd-boot">systemd-boot</a> rather than Grub as bootloader.Also, I have set LUKS encryption for my root XFS disk volume.</p>
<p>I installed a 500GB hard disk drive on the motherboard and later erase it into XFS file system.This disk will serve as the backup volume, mounted at <code>/run/media/admin/715335b3-bd5e-4ee4-8cde-c1298fe669df/</code> by KDE Device-Auto-Mount(715335b3-bd5e-4ee4-8cde-c1298fe669df is the UUID of the disk partition it can be found by <code>blkid</code> command ).</p>
<p>Notice: You can also make backup disk mount automatically by configure <code>/etc/fstab</code>, but I won't make a deep explanation here.</p>
<h2 id="install-backrest"><a class="zola-anchor" href="#install-backrest" aria-label="Anchor link for: install-backrest">Install backrest</a></h2>
<p>There is an official <a href="https://github.com/garethgeorge/backrest?tab=readme-ov-file#installation">guide</a> for installing backrest.</p>
<p>Here I write a few commands suitable for mostly Linux Distros to install it.</p>
<pre style="background-color:#0f1419;color:#bfbab0;"><code><span>mkdir ~/Downloads
</span><span>
</span><span>cd ~/Downloads
</span><span>
</span><span>curl -L https://github.com/garethgeorge/backrest/releases/latest/download/backrest_Linux_x86_64.tar.gz -o ~/Downloads/backrest_Linux_x86_64.tar.gz
</span><span>
</span><span>mkdir ~/Downloads/backrest_Linux_x86_64
</span><span>
</span><span>tar -zxvf ~/Downloads/backrest_Linux_x86_64.tar.gz -C ~/Downloads/backrest_Linux_x86_64
</span><span>
</span><span>sudo cp ~/Downloads/backrest_Linux_x86_64/backrest /usr/bin/backrest
</span><span>
</span><span>rm -rf ~/Downloads/backrest_Linux_x86_64 ~/Downloads/backrest_Linux_x86_64.tar.gz
</span><span>
</span></code></pre>
<p>Then input <code>backrest</code> in terminal to see if it works.</p>
<p>After that, create a <code>backrest.service</code> to manage backrest by systemd.</p>
<p><code>/etc/systemd/system/backrest.service</code></p>
<pre style="background-color:#0f1419;color:#bfbab0;"><code><span>[Unit]
</span><span>Description=Backrest Service
</span><span>After=network.target
</span><span>
</span><span>[Service]
</span><span>Type=simple
</span><span>User=root
</span><span>Group=root
</span><span>ExecStart=/usr/bin/backrest
</span><span>Environment=&quot;BACKREST_PORT=127.0.0.1:9898&quot;
</span><span>
</span><span>[Install]
</span><span>WantedBy=multi-user.target
</span><span>
</span></code></pre>
<p>PS: Here I set <code>User=root</code> to make sure backrest could read all files.</p>
<pre style="background-color:#0f1419;color:#bfbab0;"><code><span>sudo systemctl daemon-reload
</span><span>sudo systemctl enable backrest --now
</span><span>sudo systemctl status backrest
</span><span>
</span></code></pre>
<h2 id="configure-backrest"><a class="zola-anchor" href="#configure-backrest" aria-label="Anchor link for: configure-backrest">Configure backrest</a></h2>
<p>Browse to your backrest webui at localhost:9898</p>
<p>Then you'll see a interface to let you create the admin role of backrest.</p>
<p>I just let [Disable Authentication] ✔️, but if your system isn't under NAT, you ought to create username and input a strong password.</p>
<h4 id="add-repo"><a class="zola-anchor" href="#add-repo" aria-label="Anchor link for: add-repo">Add Repo:</a></h4>
<p>Click [+ Add Repo], here is my configuration:</p>
<p><img src="https://static.yon.im/image/blog/use-backrest-for-Linux-full-backup/1.avif" alt="1" /></p>
<p><strong>Explanation:</strong></p>
<ul>
<li>[Repo Name] is doesn't matter what you set.</li>
<li>[Repository URI] is the directory of the backup disk where you mount.(I set under /CachyOS to make the location of backup folder not at the root directory of this disk volume.)</li>
<li>[Password] should be set by yourself,it is like the passphrase for encryption.</li>
</ul>
<h4 id="add-plan"><a class="zola-anchor" href="#add-plan" aria-label="Anchor link for: add-plan">Add Plan:</a></h4>
<p>After [Submit] the configuration of Restic Repository, you need to click [+ Add Plan]</p>
<p><img src="https://static.yon.im/image/blog/use-backrest-for-Linux-full-backup/2.webp" alt="2" /></p>
<p><strong>Explanation:</strong></p>
<ul>
<li>[Plan Name] is doesn't matter what you set.</li>
<li>[Repository] is just as [Repo Name]</li>
<li>[Paths] should be set as root directory i.e. / (So it could do a full backup)</li>
<li>[Excludes] are the directories should not be backed up.(At least set as the example)</li>
<li>[Backup Schedule] as the example it will automatically do a backup every 4 hours.(You can change it by yourself.)</li>
<li>[Clock for schedule] just recommand to set as [Last Run Time]</li>
<li>[Backup Flags] add <code>--one-file-system</code> so /proc /tmp and so on won't be backuped.(More explanations here: <a href="https://restic.readthedocs.io/en/latest/040_backup.html#excluding-files">https://restic.readthedocs.io/en/latest/040_backup.html#excluding-files</a></li>
</ul>
<h4 id="test"><a class="zola-anchor" href="#test" aria-label="Anchor link for: test">Test:</a></h4>
<p><img src="https://static.yon.im/image/blog/use-backrest-for-Linux-full-backup/3.avif" alt="3" /></p>
<p>Click [Backup Now], wait the first long full backup process done.(Here I have backuped before, so just take a look the success result.)</p>
<p><img src="https://static.yon.im/image/blog/use-backrest-for-Linux-full-backup/4.webp" alt="4" /></p>
<p>At this point, the configuration of backrest is complete. It will automatically backup the whole system seamlessly in the background.</p>
<h2 id="restore"><a class="zola-anchor" href="#restore" aria-label="Anchor link for: restore">Restore</a></h2>
<p>Now, suppose your Linux system disk just explodes, only left your backup volume.</p>
<p>Luckily, you have a disaster recovery because of the automatically backup by backrest.</p>
<p>So let's go to the LiveCD of your Linux Distro(as for me it is CachyOS LiveCD) , and make your system restore like before.</p>
<hr />
<h4 id="first"><a class="zola-anchor" href="#first" aria-label="Anchor link for: first">First:</a></h4>
<p>Install backrest in LiveCD</p>
<pre style="background-color:#0f1419;color:#bfbab0;"><code><span>mkdir ~/Downloads
</span><span>
</span><span>cd ~/Downloads
</span><span>
</span><span>curl -L https://github.com/garethgeorge/backrest/releases/latest/download/backrest_Linux_x86_64.tar.gz -o ~/Downloads/backrest_Linux_x86_64.tar.gz
</span><span>
</span><span>mkdir ~/Downloads/backrest_Linux_x86_64
</span><span>
</span><span>tar -zxvf ~/Downloads/backrest_Linux_x86_64.tar.gz -C ~/Downloads/backrest_Linux_x86_64
</span><span>
</span><span>sudo cp ~/Downloads/backrest_Linux_x86_64/backrest /usr/bin/backrest
</span><span>
</span><span>rm -rf ~/Downloads/backrest_Linux_x86_64 ~/Downloads/backrest_Linux_x86_64.tar.gz
</span><span>
</span></code></pre>
<p>Switch to the root user to get full file access.</p>
<pre style="background-color:#0f1419;color:#bfbab0;"><code><span>sudo -i
</span><span>or
</span><span>su root
</span></code></pre>
<p>Then input <code>backrest</code> in terminal, but this time, do not close <code>backrest</code> in terminal, and also no need of systemd-service.</p>
<p>Just browse to your backrest webui localhost:9898</p>
<p><img src="https://static.yon.im/image/blog/use-backrest-for-Linux-full-backup/5.avif" alt="5" /></p>
<p>Then you need to restore your configuration like before manually.</p>
<p><img src="https://static.yon.im/image/blog/use-backrest-for-Linux-full-backup/6.webp" alt="6" /></p>
<p><img src="https://static.yon.im/image/blog/use-backrest-for-Linux-full-backup/7.webp" alt="7" /></p>
<h4 id="second"><a class="zola-anchor" href="#second" aria-label="Anchor link for: second">Second:</a></h4>
<p>Erase a new disk for your new Linux system disk, here use Gparted for a quick work.</p>
<p><img src="https://static.yon.im/image/blog/use-backrest-for-Linux-full-backup/8.webp" alt="8" /></p>
<p><img src="https://static.yon.im/image/blog/use-backrest-for-Linux-full-backup/9.webp" alt="9" /></p>
<p><img src="https://static.yon.im/image/blog/use-backrest-for-Linux-full-backup/10.webp" alt="10" /></p>
<p>Notice: You should add [boot] &amp; [esp] flags to the Fat32 EFI volume.Click [Manage Flags] to do this.</p>
<p><img src="https://static.yon.im/image/blog/use-backrest-for-Linux-full-backup/11.webp" alt="11" /></p>
<p><img src="https://static.yon.im/image/blog/use-backrest-for-Linux-full-backup/12.webp" alt="12" /></p>
<h4 id="third"><a class="zola-anchor" href="#third" aria-label="Anchor link for: third">Third:</a></h4>
<p>Mount the new Linux system disk partition and EFI partition.</p>
<pre style="background-color:#0f1419;color:#bfbab0;"><code><span>sudo -i
</span><span>mkdir /mnt/boot
</span><span>mount /dev/sdc2 /mnt
</span><span>mount /dev/sdc1 /mnt/boot
</span><span>
</span><span>Notice: /dev/sdcX is define by your system environment, you can use command `lsblk` and `blkid` to see this.
</span><span>
</span></code></pre>
<p>Now you can execute restore command in backrest.</p>
<p><img src="https://static.yon.im/image/blog/use-backrest-for-Linux-full-backup/13.webp" alt="13" /></p>
<p>Notice: This process may take a lot of time, but you need to be patient.</p>
<h4 id="finally"><a class="zola-anchor" href="#finally" aria-label="Anchor link for: finally">Finally:</a></h4>
<p>It's almost done, just need to fix bootloader.</p>
<pre style="background-color:#0f1419;color:#bfbab0;"><code><span>genfstab -U /mnt &gt; /mnt/etc/fstab
</span><span>
</span><span>arch-chroot /mnt
</span><span>
</span><span>bootctl install
</span><span>
</span><span>paru -S linux-cachyos
</span><span>
</span><span>Notice: `paru -S linux-cachyos` is works only in CachyOS(or other Arch Linux), if you&#39;re using other Linux Distro, you may needn&#39;t run this command.
</span><span>
</span><span>mkinitcpio -P
</span><span>
</span></code></pre>
<p>Notice: /etc/crypttab should be reconfigured if your system once have LUKS crypt.</p>
<p>Now, you could reboot, and boot into the formal system before the accident happened.</p>
<h3 id="more-about-luks-encryption"><a class="zola-anchor" href="#more-about-luks-encryption" aria-label="Anchor link for: more-about-luks-encryption">More About LUKS encryption</a></h3>
<p>If you need LUKS encryption for the root partition, you need to create an encrypted root volume before restoring.However, due to space limitations, I won't go into more detail.</p>
<h2 id="acknowledgements"><a class="zola-anchor" href="#acknowledgements" aria-label="Anchor link for: acknowledgements">Acknowledgements</a></h2>
<ul>
<li><a href="https://github.com/restic/restic">https://github.com/restic/restic</a></li>
<li><a href="https://github.com/garethgeorge/backrest">https://github.com/garethgeorge/backrest</a></li>
</ul>

        </section>

        

    </article>
</main>


    </div>
</body>

</html>